---
# setspace: doublespacing
output: 
    pdf_document:
      includes:
        in_header: import.sty
        before_body: title.sty
      keep_tex: yes
      number_sections: yes
      # toc: yes
      toc_depth: 2

# linestretch: 2
bibliography: MasterOfCellTypes.bib
fontsize: 11
# csl: chicago-author-date.csl
csl: nature.csl
---
```{r include=FALSE, cache=FALSE}
```

Resum 
====================================================

Aquest estudi realitza una anàlisi exhaustiva de la Loteria de Nadal (període 2000-2025) per dets de *web scraping* i modelització avançada, les autores han validat la integritat del sistema, concloent que:

-   L'equitat física està garantida: L'ús de boles de fusta de boix amb gravat làser evita biaixos per pes de tinta.

-   Convergència a la uniformitat: L'estudi de més de 45.000 boles extretes confirma que totes les terminacions tenen probabilitats similars, seguint la Llei dels Grans Nombres.

-   Incapacitat predictiva: S'han testejat models de *Machine Learning* (Random Forest) i estadístics (LMM, GLM Gamma) per intentar predir el premi segons la paritat o la suma de dígits, sense èxit. El sorteig és, a efectes pràctics, atzar pur.

\newpage

Objectiu i motivacions del treball
=======================================================================================================================

L'estudi no neix sols d'una curiositat acadèmica, sinó d'una disputa familiar clàssica que es repeteix cada desembre a cada d'una de les autores.

L'interès per aquest tema sorgeix de la dinàmica entre el seu germà, d'esperit profundament científic i recional, i la seva mare. Cada any, quan arriba el moment de comprar els dècims, s'encén el debat on el seu germà sosté amb fermesa que la loteria és una pèrdua de temps i diners, argumentant que estadíticament, "mai toca res" i la seva mare, en canvi, manté viva il·lusió i la tradició, convençuda que, per petita que sigui la probabilitat, "alguna cosa tocarà".

Aquesta tensió entre el rigor científic i la il·lusió popular ha estat el motor per plantejar els següents objectius:

1.  **Verificar l'aleatorietat**: Determinar si el sorteig és realment atzarós o si el germà té raó en la seva visió escèptica.

2.  **Avaluar la predictibilitat**: Comprovar si existeix alguna estratègia basada en dades històriques que pugui donar la raó a la mare i augmentar les possibilitats de guanyar.

3.  **Analitzar mites populars**: Sotmetre a prova creences com la dels números "bonics" o la paritat per veure si tenen fonament real.

\newpage

Loteria de Nadal
=======================================================================================================================

En aquest repositori es recull el desenvolupament del Treball Final de Consultoria Estadística 2025, centrat en l'anàlisi exhaustiva de la Loteria de Nadal des de la seva vessant més tècnica. L'objectiu no és sols descriure el sorteig, sinó avaluar amb rigor estadístic si la variabilitat dels resultats històrics (des del 2000 fins a l'anys 2025) respon purament a l'atzar o si existeixen anomalies mesurables en l'homogeneïtat del sistes,

A través de metodologies de web scraping, tests d'independència, etc

La Loteria de Nadal no és sols un sorteig de boles; és l'unic moment de l'any en què un país sencer es posa d'acord per ignorar les lleis de l'estadística. Des d'un punt de vista matemàtic, és un "impost a l'esperança", però des del punt de vista de lesa dades, és un ecosistema fascinant.

**L'arquitectura del "GORDO"**

El sistema de la Loteria Nacional no treballa amb números a l'atzar, sinó amb una jerarquia rígida que determina les probabilitats reals d'èxit. L'estructura per al sorteig actualment es basa en:

-   **Univers numèric:** 100.000 números únics (del 00000 al 99999). Això estableix una probabilitat base de guanyar el primer premi amb un sol dècim del 0.001%.

-   **Emissió:** La societat Estatal de Loteries i Apostes de l'Estat (SELAE) ha emès per l'any pasat 197 sèries per cada números. Atès que cada sèrie es divideix en 10 dècims, hi ha un total de 1970 dècims de cada número al mercat.

-   **Volum econòmic:** Amb un preu de 20€ per dècim, la recaptació potencial ascendeix a 3.940 milions d'euros. D'acord amb la normativa, el 70% d'aquest import es destina a premis.

**Física i Homogeneïtat del Sorteig**

Com assenyla el professor Llorenç Badiella, el que percebem com a folklore televisiu és, en realitat, un procés de física aplicada dissenyat per garantir l'equitat absoluta:

-   **Les boles:** Hi ha 100.000 boles al bombo gran, totes fabricades en fusta de boix, amb un diàmetre de 3 cm i un pes unificat.

-   **Impressió làser:** Per evitar que la pintura alteri el pes (eliminant la teoria que números amb molta tinta, com el 88888, pesen més que l'11111), els números estan gravats amb làser.

-   **Mecànica:** Es fan servir dos bombos simultanis, el gran per als números i el petit per a les 1805 boles de premis. Els sorteif només finalitza quan el bombo de premis queda totalment buit.

**El repartiment del "Pastís"**

Tot i que el focus està en el "Gordo", la realitat és que el sorteig és una "pluja fina" de premis petits, per augmentar l'esperança per l'any que ve.

| Premi                 | Import per dècim | Boles premiades     | Probabilitat |
|-------------------|------------------|------------------|------------------|
| 1r premi ("el Gordo") | 400.000€         | 1                   | 0,001%       |
| 2n premi              | 125.000€         | 1                   | 0,001%       |
| 3r premi              | 50.000€          | 1                   | 0,001%       |
| 4rt premi             | 20.000€          | 2                   | 0,002%       |
| 5é premi              | 6.000€           | 8                   | 0,008%       |
| La Pedrea             | 100€             | 1.794               | 1,794%       |
| Reintegrament         | 20€              | 1 de cada 10 xifres | 10,00%       |

**Premi per proximitat i derivat**

Més enllà de les boles extretes, existeixen premis calculats per la relació numèrica amb els guanyadors:

-   **Aproximacions (a):** Premien els números immediatament anterior i posterior del "Gordo", 2n premi i del tercer, on s'obtén 200€, 125€ i 96€ respectivament.

-   **Centenes (c):** Es premien els 99 números que comparteixen les tres primeres xifres amb els quatre primers premis (tota la centena), on s'obtén 100€.

-   **Terminacions (t):** Es premien els números que coincideixen en les dues últimes xifres amb els tres primers premis, on s'obtén 100€.

-   **Reintegrament:** el retorn del valor del dècim (20€) si l'última xifra coincideix amb la del primer premi. Hi ha un 10% de probabilitat d'obtenir-lo.

\newpage

**L'impacte Fiscal**

És important destacar que el premi "net" és inferior al nominal per a les quantitats grans. L'agència Tributària aplica un 20% d'impost a la quantitat que superi els 40.000€ (que estan exempts):

-   Gordo: Es tributa pel 20% de 360.00€. Premi net = 328.000€

-   2n Premi: Es tributa pel 20% de 85.000€. Premi net = 108.000€

-   3r Premi: Es tributa pel 20% de 10.000€ = 48.000€

\newpage

Lectura de dades i preprocessament
=======================================================================================================================

A continuació, s'introdueix el conjunt de dades utilitzat en l'estudi i es descriu el procés seguit per a la seva obtenció i el preprocessament necessari. Aquest pas és fonamental per garantir la integritat de l'anàlisi descriptiu i la validesa dels models posteriors. L'objectiu inicial és explorar el comportament general dels números premiats mitjançant taules de síntesi i visualitzacions gràfiques.

Font d'obtenció i naturalesa de les dades
------------------------------------------------------------------------------------------------------------------------

El conjunt de dades utilitzat en aquest estudi s'ha extret principalment dels arxius oficials publicats per la Sociedad Estatal de Loterías y Apuestas del Estado (SELAE), l'entitat responsable de la Loteria de Nadal. Aquests arxius, disponibles de manera sistemàtica des de l'any 2000, contenen la totalitat dels números premiats en cada sorteig, incloent-hi la seva categoria i l'import corresponent.

A la Figura següent es pot observar un exemple de la font original d'on s'han obtingut les dades, mostrant l'estructura típica del llistat oficial:

\begin{figure}[h]
  \centering
  \includegraphics[width=0.5\textwidth]{loteria.png}
  \caption{Resultats Sorteig Loteria de Nadal (2023)}
\end{figure}

A partir d'aquesta font, s'ha realitzat una extracció de la informació rellevant (any, número, premi, lletra), que posteriorment s'ha emmagatzemat en un fitxer amb format `.txt` per al seu processament. La lectura i el tractament de les dades s'ha implementat mitjançant un script d'R extern, dissenyat per automatitzar la unificació dels 26 anys analitzats. També s'ha generat un fitxer en format `.xlsx` per facilitar la reproductibilitat de l'estudi per part de tercers.

Estructura del Dataset
------------------------------------------------------------------------------------------------------------------------

Per tal de familiaritzar-nos amb la matriu de dades, es presenten a continuació dues taules. La primera mostra un extracte real dels números premiats corresponents al sorteig més recent (2025), mentre que la segona ofereix una visió agregada de tot el període d'estudi. Cada registre inclou el número premiat, la seva categoria (identificada per la "lletra"), l'import del premi en euros i l'any del sorteig.

```{r echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
library(tidyverse); library(readxl); library(readr); library(kableExtra)
library(lme4); library(lmerTest); library(randomForest)

dades <- read_xlsx("loteria-2000-2025.xlsx")
dades <- dades %>%
  mutate(premi = ifelse(any <= 2001, premi/166.386, premi))
dades$premi <- round(dades$premi, 2)
exemple <- head(dades[dades$any==2025,], 5)
taula1 <- exemple %>%
  kable(format = "latex", booktabs = TRUE, caption = "Primers registres del sorteig 2025") %>% 
  kable_styling(font_size = 9, latex_options = "HOLD_position")

options(scipen = 999)
resum_lletres <- dades %>%
  count(lletra) %>%
  mutate(lletra_txt = paste0(ifelse(is.na(lletra), "Bombo", lletra), ": ", n)) %>%
  pull(lletra_txt) %>%
  paste(collapse = " | ")

resum_global <- tibble(
  Variable = c("Anys analitzats", "Total de números premiats", "Premi mínim (€)", "Premi màxim (€)", "Categories (Lletra)"),
  Valor = c(n_distinct(dades$any), nrow(dades), min(dades$premi, na.rm = TRUE), max(dades$premi, na.rm = TRUE), resum_lletres)
)

taula2 <- resum_global %>%
  kable(format = "latex", booktabs = TRUE, caption = "Resum global del conjunt de dades (2000-2025)") %>%
  kable_styling(font_size = 9, latex_options = "HOLD_position")

taula1; taula2
```

Podem observar com cada registre té l'import del premi, la seva categoria, la moneda (Euros o pessetes) i l'any del sorteig. En el període de 26 anys que analitzarem, hi han hagut 127.664 números premiats.

També s'utilitza el conjunt de dades de l'històric dels premis de la Grossa des de l'inici del sorteig, l'any 1812, fins a l'actualitat. Aquestes dades han estat obtingudes a partir de fonts disponibles a internet, i podeu veure un extracte de les dades a continuació:

```{r echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
library(readr); library(ggplot2)
historial <- read_table(
  "historial_gordo.txt",
  col_types = cols(
    Any = col_integer(),
    Numero = col_character(),
    Terminació = col_integer()))

taula3 <- head(historial, 2) %>%
  kable(format = "latex", booktabs = TRUE, caption = "Conjunt de dades de la Grossa (1812-2025)") %>%
  kable_styling(font_size = 9, latex_options = "HOLD_position")

taula3
```


Estadístiques descriptives i anàlisi de l'atzar
=======================================================================================================================

Un cop realitzada la lectura del conjunt de dades, procedim amb l'anàlisi descriptiu per proporcionar una visió global del comportament de les dades per identificar distribucions, així com detectar possibles patrons o irregularitats del sorteig.

Distribució històrica de l'última xifra (1812-2025)
------------------------------------------------------------------------------------------------------------------------

Tot i que l'anàlisi principal d'aquest estudi se centra en el període 2000-2025, s'ha considerat rellevant examinar la distribució històrica de l'última xifra del número guanyador del primer premi des de l'inici del sorteig, l'any 1812.

Aquest estudi és interessant, ja que si un dècim coincideix en l'última xifra amb la del primer premi, el jugador obté el reintegrament, recuperant així els diners invertits. Per aquest motiu, l'estudi de les terminacions pot aportar informació addicional sobre el comportament global del sorteig al llarg del temps.

L'anàlisi permetrà avaluar si hi ha algun patró existent en la freqüència d'aparicions de les xifres.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=5, fig.height=3, fig.align='center'}

df_plot <- historial %>%
  count(Terminació) %>%
  mutate(Terminació = factor(Terminació, levels = 0:9))

ggplot(df_plot, aes(x = Terminació, y = n, fill = n)) +
  geom_col(show.legend = FALSE, width = 0.6) +
  geom_text(aes(label = n), vjust = -0.4, size = 2.5, fontface = "bold") +
  scale_fill_gradient(low = "skyblue", high = "steelblue") +
  labs(
    title = "Distribució de l'última xifra",
    subtitle = "Grossa 1812-2025",
    x = "Última xifra",
    y = "Freqüència"
  ) +
  theme_minimal(base_size = 9) +
  theme(
    axis.text.x = element_text(face = "bold", size = 8),
    axis.title = element_text(face = "bold", size = 9),
    plot.title = element_text(face = "bold", size = 10),
    plot.subtitle = element_text(size = 8)
  )
```

A partir de les dades analitzades, s'observa que les terminacions 5, 4, 6 i 8 són les que han aparegut amb més freqüència com a última xifra del número guanyador, amb 31, 27, 26 i 25 aparicions, respectivament. En canvi, les terminacions 1 i 9 presenten les freqüències més baixes.

Tot i aquestes diferències, el comportament de les dades és compatible amb la variabilitat d'un procés aleatori. Per tant, en principi, no podrem establir cap predicció fiable sobre futures terminacions.

Verificació d'homogeneïtat en el període modern (2000-2025)
------------------------------------------------------------------------------------------------------------------------

Més enllà del primer premi, hem analitzat els **127.664 registres** de números premiats en els darrers 26 anys. En explorar aquest volum de dades, hem detectat una distinció crucial per a la validesa de l'estudi:

1.  **Premis de bombo (Atzar físic):** Són els números que surten físicament del bombo (Pedrea i premis majors). Al nostre dataset, són aquells que no tenen cap lletra associada, básicament són aquells que representen l'extracció directe i aleatòria.

2.  **Premis derivats:** Són aquells premis que no surten d'una bola pròpia, sinó que es concedeixen per la relació numèrica amb els guanyadors principals, com ja ho haviem nombrat abans.

A continuació, comparem la distribució de les terminacions de les boles extretes per veure si l'atzar és realment homogeni:

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=5, fig.align='center'}
df_boles <- dades %>% 
  filter(is.na(lletra)) %>% 
  mutate(terminacio = as.numeric(numero) %% 10)

df_counts <- df_boles %>% count(terminacio)

# Gràfic de verificació d'homogeneïtat
ggplot(df_counts, aes(x = factor(terminacio), y = n, fill = n)) +
  geom_col(show.legend = FALSE, width = 0.7, color = "white") +
  geom_hline(yintercept = nrow(df_boles)/10, linetype = "dashed", color = "red", alpha = 0.5) +
  geom_text(aes(label = n), vjust = -0.5, size = 3) +
  scale_fill_viridis_c(option = "mako", begin = 0.4, end = 0.8) +
  labs(
    title = "Verificació d'Atzar: Terminacions de Boles (2000-2025)",
    subtitle = "La línia vermella indica la freqüència teòrica esperada (distribució uniforme)",
    x = "Últim dígit",
    y = "Vegades premiat"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5))
```

Aquest gràfic ens revela un convergència clara cap a la uniformitat estadística que valida la integritat del sortieig en el període modern. A diferència de la mostra històrica reduïda de la Grossa, l'estudi de les més de quaranta-cinc mil boles extretes del bombo confirma que les terminacions segueixen la Llei de Grans Nombre i es distribueixen de manera equilibrada al voltant de la mitjana teòrica. 

Aquest equilibri actua com a una evidència empírica de l'equitat mecànica del sistema, demostrant que el disseny físic de les boles i el seu gravat làser garanteixen que cap número tingui una probabilitat d'extracció superior a la resta. 

Finalment, els resultats refirmen el rigor metodològic d'haver separat els premis d'extracció directa dels derivats per càlcul, ja que només així s'ha pogut verificar que el bombo funciona com un generador d'atzar pur sense biaixos detectables.

\newpage

Modelització i validació estadística 
=======================================================================================================================

En aquesta secció, apliquem tècniques d'estadística avançada per sotmetre a prova l'aleatorietat del sorteig. L'objectiu és determinar si existeix alguna variable (com el rang numèric, la paritat o la suma de dígits) que permeti obtenir un avantatge predictiu, o si, per contra, ens trobem davant d'un sistema d'atzar pur.

L'impacte de l'evolució del bombo
------------------------------------------------------------------------------------------------------------------------

Un dels canvis estructurals més rellevants a estudiar al llarg del període estudiat és l'ammpliació progressiva del nombre total de boles al bombo:

-   P1 (fins al 2004): 66.000 números.

-   P2 (2005-2010): 85.000 números.

-   P3 (des de 2011): 100.000 números.

Aquest increment té un efecte directe en l'espai mostral del sorteig. L'anàlisi següent avalua si el bombo s'ha adaptat correctament a aquestes ampliacions, desplaçant proporcionalment els premis cap a les noves franges numèriques.

Per avaluar aquest aspecte, s'han agrupat els números premiats en tres rangs (baix, mitjà i alt), i s'ha avaluat el percentatge de premis assignats a cada franja dins de cada període. 

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=7, fig.height=3, fig.align='center'}
library(tidyverse)
library(readxl)
library(kableExtra)
library(lme4)
library(lmerTest)
library(randomForest)
df_net <- dades %>%
  mutate(
    numero = as.numeric(as.character(numero)),
    premi = as.numeric(as.character(premi)),
    # Unifiquem NAs a la columna lletra
    lletra = ifelse(is.na(lletra) | lletra == "", "Bombo (Directe)", lletra),
    periodo = case_when(
      any <= 2004 ~ "P1 (fins 2004)",
      any <= 2010 ~ "P2 (2005-2010)",
      TRUE        ~ "P3 (des de 2011)"
    ),
    rang_num = case_when(
      numero < 66000 ~ "Baix (0-65999)",
      numero < 85000 ~ "Mig (66000-84999)",
      TRUE           ~ "Alt (85000-99999)"
    )
  )

# Gràfic d'evolució
resum_evolucio <- df_net %>%
  group_by(periodo, rang_num) %>%
  summarise(total = n(), .groups = 'drop') %>%
  group_by(periodo) %>%
  mutate(percentatge = (total / sum(total)) * 100)

ggplot(resum_evolucio, aes(x = periodo, y = percentatge, fill = rang_num)) +
  geom_bar(stat = "identity", width = 0.7, color = "white") +
  geom_text(aes(label = paste0(round(percentatge, 1), "%")), 
            position = position_stack(vjust = 0.5), color = "white", fontface = "bold") +
  scale_fill_manual(values = c("Baix (0-65999)" = "#2c3e50", "Mig (66000-84999)" = "#3498db", "Alt (85000-99999)" = "#95a5a6")) +
  labs(title = "Adaptació del sistema: Distribució de premis per franja", 
       subtitle = "El sistema integra les noves boles sense biaixos cap als números antics",
       x = "Període", y = "% del total de premis", fill = "Rang") +
  theme_minimal() + coord_flip()
```

Al gràfic podem observar que, durant el segon període (2005-2010) amb l'ampliació del bombo fins als 85.000 números, els premis es distribueixen gairebé com s'esperava. La distribució teòrica dels premis és del 77.6% per a la franja baixa i del 22.4% per a la franja mitjana. Els percentatges observats s'ajusten bé als valors teòrics, amb una lleugera diferència que es pot explicar amb la variabilitat inherent d'un procés aleatori.

Durant el període P3, la distribució esperada dels premis segons la mida de cada franja és del 66% per a la franja baixa, del 19% per a la franja mitjana i del 15% per a la franja alta. Els percentatges observats es tornen a ajustar molt bé als valors teòrics, sense tenir evidència de biaix, la qual cosa reforça la hipòtesi que els premis es distribueixen de manera aleatòria. 


Anàlisi de variables ocultes: Mite vs. Realitat
------------------------------------------------------------------------------------------------------------------------

Existeix la creença popular que certs números ("bonics", parells, o amb certes sumes) tenen més probabilitat de ser premiats. Per contrastar aquesta hipòtesi amb rigor matemàtic, hem construït un Model Lineal Mixt (LMM).

-   Variable Resposta: Logaritme base 10 del premi (*log10(premi)*), per normalitzar la distribució.

-   Predictors Fixos: Paritat del número (Parell/Senar) i Suma dels cinc dígits del número (ex: 12345 = 15).

-   Efecte Aleatori: Any del sorteig ($1 | any$), per controlar la variabilitat econòmica i estructural de cada edició.

El model s'ha ajustat amb lmer() i mostra l'efecte de la paritat i de la suma dels dígits sobre el logaritme del premi.

```{r echo=FALSE, message=FALSE, warning=FALSE}
df_model <- df_net %>%
  filter(premi > 0, lletra == "Bombo (Directe)") %>%
  mutate(
    es_parell = factor(numero %% 2 == 0, labels = c("Senar", "Parell")),
    suma_digits = (numero %/% 10000) + (numero %/% 1000 %% 10) + 
                  (numero %/% 100 %% 10) + (numero %/% 10 %% 10) + (numero %% 10),
    log_premi = log10(premi)
  )

model_mixt <- lmer(log_premi ~ es_parell + suma_digits + (1 | any), data = df_model)
summary_model <- summary(model_mixt)$coefficients %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  rename(Estimate = `Estimate`, Std_Error = `Std. Error`, t_value = `t value`)

summary_model %>%
  kable("latex", booktabs = TRUE, caption = "Coeficients fixos del LMM: Paritat i Suma de dígits") %>%
  kable_styling(font_size = 9, latex_options = c("HOLD_position"))
```

Aquesta taula mostra que els coeficients de ser parell i la suma dels dígits són molt propers a zero. Podem observar que p-valors són majors que el nivell de significació del 0.05, i per tant, no són significatius. Indicant que cap de les variables tenen un impacte rellevant sobre el premi. 

Per a complementar aquesta anàlisi, hem representat gràficament les variables:

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=5, fig.height=3, fig.align='center'}
# Visualització del mite de la paritat
p1 <- ggplot(df_model, aes(x = es_parell, y = log_premi, fill = es_parell)) +
  geom_violin(alpha = 0.5) +
  geom_boxplot(width = 0.1, color = "black") +
  labs(title = "Mite: Paritat vs Valor del Premi", x = "Paritat", y = "Log10(Premi)") +
  theme_minimal() + theme(legend.position = "none")
p1
```

Aquest gràfic ens permet observar si la distribució dels premis varien segons si el número és parell o senar. Tant i com hem vist, les distribucions són molt similars i les medianes gairebé coincideixen, per tant, no hi ha evidència que la paritat afecti el premi. 

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=5, fig.height=3, fig.align='center'}
# Visualització de la suma de dígits
p2 <- ggplot(df_model, aes(x = suma_digits, y = log_premi)) +
  geom_jitter(alpha = 0.1, color = "steelblue", size = 0.5) +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  labs(title = "Mite: Suma de dígits", x = "Suma", y = "Log10(Premi)") +
  theme_minimal()
p2
```

En aquest segon gràfic observem si existeix alguna relació lineal entre la suma dels dígits del número i el valor del premi. La línia vermella representa la tendència estimada pel model. 

\newpage
Com es pot apreciar, la recta de regressió és pràcticament horizontal i la majoria dels punts es distribueixen de manera uniforme al voltant d'aquesta línia. Això indica qeu la suma dels dígits no exerceix cap influència significativa sobre el logaritme del premi. En ambdós casos, els gràfics serveixen per visualitzar que les creences populars són només mites, i reforcen les conclusions del LMM. 

Comparativa de capacitat predictiva
------------------------------------------------------------------------------------------------------------------------

Per explorar fins a quin punt és possible "guanyar a la banca", hem comparat tres enfocaments per predir la quantia del premi:

1.  Model Mixt (LMM): Estadístic clàssic, que incorpora efectes aleatoris per any del sorteig

2.  GLM Gamma: Model lineal generalitzat, ideal per a valors monetaris positius.

3.  Random Forest: Algorisme de *Machine Learning* capaç de detectar patrons complexos i no lineals.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Preparació per als models
df_ml <- df_net %>%
  filter(!is.na(premi) & premi > 0)
df_ml$any_fact <- as.factor(df_ml$any)
df_ml$lletra <- as.factor(df_ml$lletra)

# 1. Model Mixt (Ja calculat anteriorment, el reajustem amb la variable 'lletra' que és la rellevant)
model_mixt_final <- lmer(log(premi) ~ lletra + (1 | any_fact), data = df_ml)

# 2. GLM Gamma
model_glm <- glm(premi ~ lletra + any_fact, family = Gamma(link = "log"), data = df_ml)

# 3. Random Forest (Mostra per eficiència)
set.seed(123)
data_mostra <- df_ml[sample(nrow(df_ml), 5000), ] 
model_rf <- randomForest(premi ~ lletra + numero, data = data_mostra, ntree = 100)

```

*Nota: Per raons computacionals, hem pres una submostra de 5000 observacions per al Random Forest.*

Com a mesura de rendiment dels models utilitzarm l'RMSE (Root Mean Squared Error), que reflecteix l'error mitjà entre els valors reals i els predits:

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Càlcul RMSE (Error de predicció)
rmse <- function(actual, predicted) sqrt(mean((actual - predicted)^2, na.rm = TRUE))

pred_mixt <- exp(predict(model_mixt_final, data_mostra, re.form = NULL))
pred_glm  <- predict(model_glm, data_mostra, type = "response")
pred_rf   <- predict(model_rf, data_mostra)

error_mixt <- rmse(data_mostra$premi, pred_mixt)
error_glm <- rmse(data_mostra$premi, pred_glm)
error_rf <- rmse(data_mostra$premi, pred_rf)
```

|  |  |  |
|----|----|----|
| **Model** | **RMSE (Error promig en €)** | **Interpretació** |
| **Model Mixt** | `r round(error_mixt, 2)` | Incapaç de reduir l'error usant l'any. |
| **GLM Gamma** | `r round(error_glm, 2)` | Captura la mitjana però no la variància extrema. |
| **Random Forest** | `r round(error_rf, 2)` | Malgrat la seva complexitat, no troba patrons. |

L'anàlisi de l'Error Quadràtic Mitjà (RMSE) dels models generats mostra la incapacitat de predir el resultat de la loteria. Tots tres models tenen un RMSE elevat, indicant que la predicció exacta del premi és molt difícil. 

Això ens torna a confirmar que els premis de la Loteria de Nadal són aleatòris i que cap patró numèric observable permet predir amb precisió la quantia guanyadora. 

\newpage 

Validació de l'aleatorietat (Test d'Uniformitat)
=======================================================================================================================

Per assegurar que el bombo no té "memòria" ni biaixos, apliquem un test uniforme per comprovar que cada xifra té la mateixa probabilitat d’aparèixer en els números guanyadors, apliquem un test de Chi-quadrat.

```{r echo=FALSE, message=FALSE, warning=FALSE}
df_digitos <- df_net %>%
  filter(!is.na(numero), lletra == "Bombo (Directe)", any >= 2011) %>% 
  mutate(numero_str = sprintf("%05d", as.numeric(numero))) %>%
  mutate(
    d1 = substr(numero_str, 1, 1),
    d2 = substr(numero_str, 2, 2),
    d3 = substr(numero_str, 3, 3),
    d4 = substr(numero_str, 4, 4),
    d5 = substr(numero_str, 5, 5)
  ) %>%
  pivot_longer(
    cols = d1:d5,
    names_to = "posicio",
    values_to = "digit"
  )
df_counts <- df_digitos %>%
  count(digit) %>%
  arrange(digit)
test_chi <- chisq.test(df_counts$n, p=rep(0.1, 10))
chi_resum <- data.frame(
  Estadístic = round(test_chi$statistic, 4),
  `Grau de llibertat` = test_chi$parameter,
  `p-valor` = signif(test_chi$p.value, 4)
)

# Mostrar la taula amb kable
chi_resum %>%
  kable("latex", booktabs = TRUE, caption = "Resultat del test Chi-quadrat per uniformitat") %>%
  kable_styling(font_size = 10, latex_options = c("HOLD_position"))
```
Estem testejant si els números segueixen una distribució uniforme, és a dir, cada dígit de 0 a 9 apareix amb la mateixa probabilitat. Podem veure que el p-valor és molt gran (>0.05), per tant, no tenim suficient evidències estadístiques per rebutjar la hipòtesi nul·la i acceptem que el sorteig és homogeni. 


\newpage
Conclusions 
=======================================================================================================================

Les conclusions d'aquest treball confirmen de manera rotunda que el Sorteig Extraordinari de Nadal és un esdeveniment basat en l'atzar pur, validant així la postura més escèptica i científica expressada pel germà en el debat familiar. L'anàlisi de la integritat física del procés demostra que l'ús de boles de fusta de boix amb un pes unificat i gravat làser garanteix una equitat absoluta, eliminant qualsevol biaix que pogués derivar de la pintura o el pes dels números. Aquesta aleatorietat es veu reforçada pels tests estadístics d'uniformitat realitzats sobre el període modern, on s'ha obtingut un p-valor de 0,7138. Aquesta xifra obliga a acceptar l'homogeneïtat del sorteig i confirma que, en la pràctica, cada dígit té exactament la mateixa probabilitat de ser extret del bombo.

Pel que fa als mites populars sobre números "bonics" o determinades propietats numèriques, els models lineals mixtos han demostrat que variables com la paritat del número o la suma dels seus cinc dígits no tenen cap impacte significatiu en la quantia del premi obtingut. Les evidències gràfiques han permès visualitzar que les distribucions de premis i les seves medianes són pràcticament idèntiques independentment de si el número és parell o senar , el que desmunta científicament qualsevol estratègia de compra basada en aquests criteris tradicionals. Així mateix, la comparativa de models de capacitat predictiva, incloent-hi algorismes de *Machine Learning* com el *Random Forest*, ha posat de manifest la impossibilitat de predir resultats futurs mitjançant l'estudi de dades històriques, ja que els elevats errors de predicció (RMSE) confirmen que el bombo no té "memòria".

D'aquesta manera, la ciència dóna la raó al germà: la probabilitat de guanyar la Grossa amb un sol dècim es manté immutable en un 0,001% , confirmant que la loteria actua matemàticament com un "impost a l'esperança". No obstant això, per mantenir viva la il·lusió de la mare i maximitzar les opcions de recuperar la inversió, l'estratègia més racional és la diversificació. Comprar números amb terminacions diferents augmenta les possibilitats d'obtenir el reintegrament, que té una probabilitat del 10%. Si es vol seguir la tradició històrica, xifres com el 5, el 4 o el 6 han estat les més freqüents des de 1812 , però cal recordar que el sorteig és, en realitat, una "pluja fina" de premis petits on la Pedrea n'és la gran protagonista amb un 1,794% de probabilitat. En definitiva, el millor premi garantit per a la família és gaudir del folklore i la tradició de compartir el dècim, acceptant que l'atzar n'és l'únic i absolut senyor.

\newpage

Annexos 
=======================================================================================================================

A continuació, introduirem el directori de Git-Hub on podràs trobar tot el codi d'R utilitzat:

https://github.com/andreaacuvilla/Loteria

\newpage
# Referències

Badiella, L. (2005). La física aplicada en la Loteria de Nadal: equitat i mecanismes de sort. Barcelona: Edicions UPC.

La Lotera. (2025). Histórico de números premiados con el Gordo de Navidad. https://lalotera.es/historico-numeros-premiados-gordo-navidad/





