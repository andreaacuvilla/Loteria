---
# setspace: doublespacing
output: 
    pdf_document:
      includes:
        in_header: import.sty
        before_body: title.sty
      keep_tex: yes
      number_sections: yes
      # toc: yes
      toc_depth: 2

# linestretch: 2
bibliography: MasterOfCellTypes.bib
fontsize: 11
# csl: chicago-author-date.csl
csl: nature.csl
---

Resum 
====================================================

El Sorteig Extraordinari de Nadal, conegut popularment com la Loteria de Nadal, és un dels esdeveniments més populars  d'Espanya i se celebra cada desembre des de 1812. Aquest estudi analitza els resultats històrics del sorteig, incloent els números guanyadors, premis i categories, amb l'objectiu de trobar patrons i distribucions de manera estadística.

\newpage

Descripció del conjunt de dades
=======================================================================================================================

Introducció de les dades 
------------------------------------------------------------------------------------------------------------------------

En aquest repositori es recull el desenvolupament del Treball Final de Consultoria Estadística 2025, centrat en l'anàlisi exhaustiva de la Loteria de Nadal des de la seva vessant més tècnica. L'objectiu no és sols descriure el sorteig, sinó avaluar amb rigor estadístic si la variabilitat dels resultats històrics (des del 2000 fins a l'anys 2025) respon purament a l'atzar o si existeixen anomalies mesurables en l'homogeneïtat del sistes,

A través de metodologies de web scraping, tests d'independència .....

La Loteria de Nadal no és sols un sorteig de boles; és l'unic moment de l'any en què un país sencer es posa d'acord per ignorar les lleis de l'estadística. Des d'un punt de vista matemàtic, és un "impost a l'esperança", però des del punt de vista de lesa dades, és un ecosistema fascinant.

**L'arquitectura del "GORDO"**

El sistema de la Loteria Nacional no treballa amb números a l'atzar, sinó amb una jerarquia rígida que determina les probabilitats reals d'èxit. L'estructura per al sorteig actualment es basa en:

-   **Univers numèric:** 100.000 números únics (del 00000 al 99999). Això estableix una probabilitat base de guanyar el primer premi amb un sol dècim del 0.001%.

-   **Emissió:** La societat Estatal de Loteries i Apostes de l'Estat (SELAE) ha emès per l'any pasat 197 sèries per cada números. Atès que cada sèrie es divideix en 10 dècims, hi ha un total de 1970 dècims de cada número al mercat.

-   **Volum econòmic:** Amb un preu de 20€ per dècim, la recaptació potencial ascendeix a 3.940 milions d'euros. D'acord amb la normativa, el 70% d'aquest import es destina a premis.

**Física i Homogeneïtat del Sorteig**

Com assenyla el professor Llorenç Badiella, el que percebem com a folklore televisiu és, en realitat, un procés de física aplicada dissenyat per garantir l'equitat absoluta:

-   **Les boles:** Hi ha 100.000 boles al bombo gran, totes fabricades en fusta de boix, amb un diàmetre de 3 cm i un pes unificat.

-   **Impressió làser:** Per evitar que la pintura alteri el pes (eliminant la teoria que números amb molta tinta, com el 88888, pesen més que l'11111), els números estan gravats amb làser.

-   **Mecànica:** Es fan servir dos bombos simultanis, el gran per als números i el petit per a les 1805 boles de premis. Els sorteif només finalitza quan el bombo de premis queda totalment buit.

**El repartiment del "Pastís"**

Tot i que el focus està en el "Gordo", la realitat és que el sorteig és una "pluja fina" de premis petits, per augmentar l'esperança per l'any que ve.

| Premi                 | Import per dècim | Boles premiades     | Probabilitat |
|--------------------|-----------------|-------------------|-----------------|
| 1r premi ("el Gordo") | 400.000€         | 1                   | 0,001%       |
| 2n premi              | 125.000€         | 1                   | 0,001%       |
| 3r premi              | 50.000€          | 1                   | 0,001%       |
| 4rt premi             | 20.000€          | 2                   | 0,002%       |
| 5é premi              | 6.000€           | 8                   | 0,008%       |
| La Pedrea             | 100€             | 1.794               | 1,794%       |
| Reintegrament         | 20€              | 1 de cada 10 xifres | 10,00%       |

**Premi per proximitat i derivat**

Més enllà de les boles extretes, existeixen premis calculats per la relació numèrica amb els guanyadors:

-   **Aproximacions (a):** Premien els números immediatament anterior i posterior del "Gordo", 2n premi i del tercer, on s'obtén 200€, 125€ i 96€ respectivament.

-   **Centenes (c):** Es premien els 99 números que comparteixen les tres primeres xifres amb els quatre primers premis (tota la centena), on s'obtén 100€.

-   **Terminacions (t):** Es premien els números que coincideixen en les dues últimes xifres amb els tres primers premis, on s'obtén 100€.

-   **Reintegrament:** el retorn del valor del dècim (20€) si l'última xifra coincideix amb la del primer premi. Hi ha un 10% de probabilitat d'obtenir-lo.

**L'impacte Fiscal**

És important destacar que el premi "net" és inferior al nominal per a les quantitats grans. L'agència Tributària aplica un 20% d'impost a la quantitat que superi els 40.000€ (que estan exempts):

-   Gordo: Es tributa pel 20% de 360.00€. Premi net = 328.000€

-   2n Premi: Es tributa pel 20% de 85.000€. Premi net = 108.000€

-   3r Premi: Es tributa pel 20% de 10.000€ = 48.000€

\newpage

Exploració de les dades
=======================================================================================================================

Metodologia d'obtenció de dades 
------------------------------------------------------------------------------------------------------------------------

Un cop definida el funcionament del sorteig, procedim a la càrrega i estructuració del conjunt de dades. Per aquest estudi s'ha utilitzat el fitxer `loteria-11-25.xlsx`, que recull els resultats dels darrers 10 anys.

Les dades provenen dels resultats oficials publicats per la SELEA. El procés de digitalització i lectura s'estructura seguint aquest flux:

1.  Capturar de dades oficials: L'endemà de cada sorteig, l'entitat publica la llista oficial per la comprovació de premis (vegeu la Figura 1).
2.  Conversió a text pla: Es realitza una extracció directa de la informació d'aquest arxiu i s'emmagatzema en un fitxer de text (`.txt`).
3.  Processament i neteja: Mitjançant l'ús del llenguatge R, s'ha desenvolupat un script extern encarregat de processar el text, normalitzar el format dels números (mantenint el 5 dígits) i categoritzar els premis per generar el fitxer `.xlsx` final utilitzat en aquest treball.

\begin{figure}[h]
  \centering
  \includegraphics[width=0.7\textwidth]{loteria.png}
  \caption{Resultats Sorteig Loteria de Nadal (2023)}
\end{figure}

Exploració descriptiva i resum del Dataset
------------------------------------------------------------------------------------------------------------------------

L'objectiu de la importació és assegurar que cada variable manté el format adequat per a l'anàlisi estadítica posterior. Tot seguit, es presenten dos resums que permeten familiaritzar-nos amb naturalesa de la mostra:

```{r include=FALSE, warning=FALSE, message=FALSE, cache=FALSE, results='asis'}
library(dplyr); library(stringr); library(tibble); library(stringi); library(purrr); library(tidyverse); library(readxl); library(ggplot2)

```

```{r include=FALSE, warning=FALSE, message=FALSE, cache=FALSE, results='asis'}
dades <- read_excel("loteria-11-25.xlsx")
```

```{r, echo = FALSE, warning=FALSE, message=FALSE}
library(kableExtra)

# Taula 1: Extracte de dades

exemple <- head(dades[dades$any==2024,])
taula1 <- exemple %>%
  kable(format = "latex", booktabs = TRUE) %>% 
  kable_styling(font_size = 9, latex_options = "HOLD_position")

# Taula 2: Resum mètric
options(scipen = 999)
resum_lletres <- dades %>%
  count(lletra) %>%
  mutate(lletra_txt = paste0(ifelse(is.na(lletra), "NA", lletra), ": ", n)) %>%
  pull(lletra_txt) %>%
  paste(collapse = " | ")

resum_global <- tibble(
  Variable = c("Anys analitzats", "Total de números premiats", "Premi mínim (€)", "Premi màxim (€)", "Lletres"),
  Valor = c(n_distinct(dades$any), nrow(dades), paste0(min(dades$premio, na.rm = TRUE), "€"),
            paste0(max(dades$premio, na.rm = TRUE), "€"), resum_lletres)
)

taula2 <- resum_global %>%
  kable(format = "latex", booktabs = TRUE) %>%
  kable_styling(font_size = 9, latex_options = "HOLD_position")

cat("\\begin{table}[ht] \\begin{minipage}{0.55\\textwidth} ", taula1, " \\captionof{table}{Mostra de premis (Sorteig 2024)} \\end{minipage} \\hfill \\begin{minipage}{0.45\\textwidth} ", taula2, " \\captionof{table}{Resum estadístic del dataset} \\end{minipage} \\end{table}")
```
La taula de l'esquerra mostra un extracte dels números premiats corresponents al sorteig del 2024. Cada fila representa un número premiat, identificat per la seva xifra, i inclou informació addicional com la lletra associada. A més, cada registre té l'import del premi, la seva categoria, la moneda (en aquest cas, sempre seràn Euros) i l'any del sorteig.  En el període de 10 anys que analitzarem, hi han hagut 53.050 números premiats. 

\newpage

Materials i Mètodes
=======================================================================================================================

Per tal d'avaluar si el sorteix de la Loria de Nadal es regeix purament per l'atzar o presenta anomalies en la seva execució física o mecànica, s'ha definit les següents metodologies d'anàlisi:

Programari i Eines de Computació
------------------------------------------------------------------------------------------------------------------------

Tot el tractament de dades, l'anàlisi estadística i les visualitzacions s'han realitzat mitjançant el llenguatge de programació R (versió4.x). S'ha utilitzat les següents llibreries del sistema:

-   `tidyverse` (`dplyr`, `ggplot2`): Per a la manipulació de dades i la generació de gràfics de freqüències.

-   `readxl`: Per a la ingesta de les dades estructurades des del fitxer `loteria-11-25.xlsx`.

-   `kableExtra`: Per a la presentació de resultats en format tabular de qualitat acadèmica

Prova de Bondat d'Ajust: Chi-quadrat de Pearson
------------------------------------------------------------------------------------------------------------------------

Aquest és el mètode central per validar l'homogeneïtat del sorteig. Utilitzarem el test de $\chi^2$ per contrastar si la distribució de les unitats (terminacions) dels 74.270 números premiats s'ajusta a una distribució uniforme discreta.

-   **Hipòtesi Nul·la (**$H_0$): Totes les xifres (del 0 al 9) tenen la mateixa probabilitat d'aparèixer ($P = 0,1$). El sorteig és homogeni.

-   **Hipòtesi Alternativa (**$H_1$): Existeix una desviació significativa; algunes terminacions apareixen amb una freqüència que no es pot explicar per l'atzar.

L'estadístic de contrast es calcula com:

$$
\chi^2 = \sum_{i=0}^{9} \frac{(O_i - E_i)^2}{E_i}
$$

On $O_i$ és la freqüència observada al nostre dataset i $E_i$ és la freqüència esperada teòrica.

Anàlisi de l'esperança matemàtica i biaix fiscal
------------------------------------------------------------------------------------------------------------------------

S'analitzarà el rendiment econòmic del jugador considerant la distribució de premis descrita en l'exploració de dades. Aquest mètode inclou el càlcul de l'esperança matemàtica neta, restant el gravamen del 20% aplicat per l'Agència Tributària als premis que superen els 40.000€.

Enginyeria de Característiques (Feature Engineering)
------------------------------------------------------------------------------------------------------------------------

Per a una anàlisi més profunda, s'han creat variables derivades a partir del número premiat:

-   **Terminació:** Extracció de l'últim dígit per a l'anàlisi de reintegraments.

-   **Centena:** Extracció dels tres primers dígits per validar si hi ha "barris" numèrics més premiats que d'altres.

\newpage

Resultats
=======================================================================================================================

Distribució de l'última xifra de la Grossa
------------------------------------------------------------------------------------------------------------------------

Tot i que l'anàlisi principal del nostre estudi se centra en el període 2011-2025, hem trobat interessant observar la distribució històrica de l'última xifra del número guanyador de la Grossa des de l'inici del sorteig. Això permet comprovar si existeix algun patró en els més de 200 anys d'història.

A continuació es mostra el gràfic de barres amb la freqüència de cada última xifra de la Grossa:

```{r, echo=FALSE}
historial <- read_table(
  "historial_gordo.txt",
  col_types = cols(
    Any = col_integer(),
    Numero = col_character(),
    Terminació = col_integer()))

df_plot <- historial %>%
  count(Terminació) %>%
  mutate(Terminació = factor(Terminació, levels = 0:9))

ggplot(df_plot, aes(x = Terminació, y = n, fill = n)) +
  geom_col(show.legend = FALSE, width = 0.6) +
  geom_text(aes(label = n), vjust = -0.4, size = 2.5, fontface = "bold") +
  scale_fill_gradient(low = "skyblue", high = "steelblue") +
  labs(
    title = "Distribució de l'última xifra (Grossa 1812-2025)",
    x = "Última xifra",
    y = "Freqüència"
  ) +
  theme_minimal(base_size = 9) +
  theme(
    axis.text.x = element_text(face = "bold", size = 8),
    axis.title = element_text(face = "bold", size = 9),
    plot.title = element_text(face = "bold", size = 10)
  )
```

Com s'observa al gràfic, la Grossa ha finalitzat més vagades en 5 (31 vegades), seguit del 4(27) i el 6 (26). Les terminacions menys afortunades històricament han estat l'1 (només 8 vegades) i el 2 (14 vegades).

Anàlisi del període modern (2011-2025)
------------------------------------------------------------------------------------------------------------------------

Més enllà del primer premi, hem analitzat els **74.270 registres** de números premiats en els darrers 14 anys. En explorar aquest volum de dades, hem detectat una distinció crucial per a la validesa de l'estudi:

1.  **Premis de bombo (Atzar físic):** Són els números que surten físicament del bombo (Pedrea i premis majors). Al nostre dataset, són aquells que no tenen cap lletra associada, básicament són aquells que representen l'extracció directe i aleatòria.

2.  **Premis derivats:** Són aquells premis que no surten d'una bola pròpia, sinó que es concedeixen per la relació numèrica amb els guanyadors principals, com ja ho haviem nombrat abans.

A continuació, comparem la distribució de les terminacions de les boles extretes per veure si l'atzar és realment homogeni:

```{r}
df_boles <- dades %>% 
  filter(is.na(lletra)) %>% 
  mutate(terminacio = as.numeric(numero) %% 10)

df_counts <- df_boles %>% count(terminacio)

# Gràfic de verificació d'homogeneïtat
ggplot(df_counts, aes(x = factor(terminacio), y = n, fill = n)) +
  geom_col(show.legend = FALSE, width = 0.7, color = "white") +
  geom_hline(yintercept = nrow(df_boles)/10, linetype = "dashed", color = "red", alpha = 0.5) +
  geom_text(aes(label = n), vjust = -0.5, size = 3) +
  scale_fill_viridis_c(option = "mako", begin = 0.4, end = 0.8) +
  labs(
    title = "Verificació d'Atzar: Terminacions de Boles (2011-2025)",
    subtitle = "La línia vermella indica la freqüència teòrica esperada (distribució uniforme)",
    x = "Dígit final",
    y = "Vegades premiat"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5))
```

Aquest segon gràfic ens revela un convergència clra cap a la uniformitat estadística que valida la integritat del sortieig en el període modern. A diferència de la mostra històrica reduïda de la Grossa, l'estudi de les més de trenda-dues mil boles extretes del bombo confirma que les
terminacions segueixen la Llei de Grans Nombre i es distribueixen de manera equilibrada al voltant de la mitjana teòrica. Aquest equilibri actua com a una evidència empírica de l'equitat mecànica del sistema, demostrant que el disseny físic de les boles i el seu gravat làser garanteixen que cap número tingui una probabilitat d'extracció superior a la resta. Finalment, els resultats refermen el rigor metodològic d'haver separat els premis d'extracció directa dels derivats per càlcul, ja que només així s'ha pogut verificar que el bombo funciona com un
generador d'atzar pur sense biaixos detectables.

Anàlisi quantitativa de les terminacions
------------------------------------------------------------------------------------------------------------------------
Més enllà de la representació visual, és necessari analitzar els valors numèrics exactes per determinar el grau de dispersió de les dades respecte al model teòric d'uniformitat. La següent taula detalla la freqüència absoluta de cada terminació en les boles extretes del bombo i la seva desviació percentual:

```{r}
taula_freq <- df_boles %>%
  count(terminacio) %>%
  mutate(
    Percentatge = (n / sum(n)) * 100,
    Desviació_Teòrica = Percentatge - 10
  ) %>%
  rename(Terminació = terminacio, Freqüència = n)

kable(taula_freq, digits = 2, booktabs = TRUE, caption = "Freqüència detallada i desviació respecte a la probabilitat teòrica (10%)") %>%
  kable_styling(latex_options = "HOLD_position", font_size = 9)
```

Com es desprèn de la taula anterior, la xifra amb una freqüència més alta en el període modern (2011-2025) ha estat el 3, amb un total de 3.301 aparicions (10,22%), mentre que la més baixa ha estat el 8, amb 3.154 (9,76%).

Aquestes dades són especialment rellevants, ja que confirmen que cap xifra es separa més d'un 0,25% del valor teòric esperat (10%). Aquesta variabilitat tan estreta en una mostra de més de 32.000 observacions reforça la tesi de l'homogeneïtat del bombo i ens permet avançar cap a la validació formal de les hipòtesis mitjançant tests d'inferència.

Presentació dels resultats
------------------------------------------------------------------------------------------------------------------------

(HE tret les lletras)
```{r, echo=FALSE}
top_categorias <- dades %>%
  filter(is.na(lletra)) %>%
  count(categoria, sort = TRUE) %>%
  slice_head(n = 25) %>%
  pull(categoria)

dades %>%
  filter(!is.na(premi), categoria %in% top_categorias, is.na(lletra)) %>%
  ggplot(aes(x = categoria, y = premi)) +
  geom_boxplot(fill = "lightblue", outlier.color = "red", outlier.shape = 1) +
  scale_y_log10() + 
  labs(
    title = "Distribució del premi per categoria",
    subtitle = "Top 25 categories d'extracció directa (Boles)",
    x = "Categoria",
    y = "Premi (€)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
```

```{r, echo=FALSE}

###Abans he fet una taula....

a <- dades %>%
  filter(!is.na(premi)) %>%
  filter(premi == max(premi, na.rm = TRUE)) %>%
  # Assegurem que el número tingui 5 dígits per agafar bé l'última xifra
  mutate(numero_str = sprintf("%05d", as.numeric(numero))) %>% 
  mutate(ultima_cifra = substr(numero_str, 5, 5)) %>%
  count(ultima_cifra)

a %>%
  ggplot(aes(x = factor(ultima_cifra), y = n, fill = n)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), vjust = -0.5, size = 3, fontface = "bold") +
  scale_fill_gradient(low = "skyblue", high = "steelblue") +
  labs(
    title = "Freqüència de l'última xifra del 'Gordo'",
    subtitle = "Anàlisi del primer premi (2011-2025)",
    x = "Última xifra",
    y = "Vegades que ha sortit"
  ) +
  theme_minimal()
```

(cambiat a sense lletra:)

```{r, eccho=FALSE}
df_digitos <- dades %>%
  filter(!is.na(numero), is.na(lletra)) %>% 
  mutate(numero_str = sprintf("%05d", as.numeric(numero))) %>%
  mutate(
    d1 = substr(numero_str, 1, 1),
    d2 = substr(numero_str, 2, 2),
    d3 = substr(numero_str, 3, 3),
    d4 = substr(numero_str, 4, 4),
    d5 = substr(numero_str, 5, 5)
  ) %>%
  pivot_longer(
    cols = d1:d5,
    names_to = "posicio",
    values_to = "digit"
  )

# Comptar la freqüència de cada dígit
df_digitos %>%
  count(digit) %>%
  ggplot(aes(x = digit, y = n, fill = n)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), vjust = -0.5, size = 3, fontface = "bold") +
  scale_fill_gradient(low = "lightgreen", high = "darkgreen") +
  labs(
    title = "Freqüència dels dígits en els números premiats",
    subtitle = "Anàlisi global de les 5 posicions (Boles del bombo)",
    x = "Dígit (0-9)",
    y = "Nombre total d'aparicions"
  ) +
  theme_minimal()
```

Validació del model
=======================================================================================================================

L’objectiu d’aquesta secció és determinar si la distribució observada en els resultats respon realment a un model d’atzar pur o si, per contra, existeixen evidències significatives de biaixos en el sorteig. Per fer-ho, passem de l’anàlisi descriptiva a la inferència estadística.

Test de Bondat d'Ajust ($\chi^2$ de Pearson)
------------------------------------------------------------------------------------------------------------------------

El mètode central per validar l’homogeneïtat del bombo és el test de Chi-quadrat, aplicat sobre les boles d’extracció directa del període 2011-2025. Aquest test contrasta si les freqüències observades s'allunyen significativament d'una distribució uniforme teòrica.

Definició de les hipòtesis:

Hipòtesi Nul·la ($H_0$): La probabilitat d'aparició de cada xifra és idèntica ($P = 0,1$). El sistema és homogeni i aleatori.

Hipòtesi Alternativa ($H_1$): La distribució no és uniforme; existeix una anomalia o biaix mecànic en el sistema.

```{r}
test_chi <- chisq.test(df_counts$n)
test_chi
```

L’anàlisi ha proporcionat un p-valor de 0,6403. En estadística, un p-valor superior al nivell de significació estàndard ($\alpha = 0,05$) indica que no hi ha proves suficients per rebutjar la hipòtesi nul·la. En aquest cas, en estar molt per sobre del llindar, podem afirmar amb una confiança molt elevada que les variacions observades entre xifres són fruit exclusiu de la variabilitat natural de l’atzar.

Robustesa i integritat de la mostra

La validació del model reafirma la decisió metodològica de segmentar les dades. Mentre que el total de premis analitzats ascendeix a 74.270 registres, la validació s'ha centrat exclusivament en les boles que surten físicament del bombo.

S'ha comprovat que, en excloure els premis derivats per càlcul (terminacions, aproximacions i centenes), el model d'uniformitat és extremadament precís. Aquest rigor estadístic permet concloure que, per al període 2011-2025, el mecanisme de bombos i boles de fusta de boix ha funcionat com un generador de números aleatoris d’alta fiabilitat, garantint l’equitat absoluta per a tots els números en joc.


\newpage
Conclusions 
=======================================================================================================================

En primer lloc, hem pogut comprovar que el sorteig és efectivamen aleatori, per la qual cosa no podem predir el número guanyador. Tot i això, hem identificat alguns patrons que, encara que no impliquen causalitat, podem augmentar lleugerament les probabilitats de guanyar. 

Analitzant tant l'històric complet com els últims 10 anys, les xifres que més han aparegut i que, per tant, asseguren al menys el reintegrament són: x, x, x, x.

Observant també les freqüències de xxx
\newpage

Annexos
=======================================================================================================================

A continuació, introduirem el directori de Git-Hub on podràs trobar tot el codi d'R utilitzat:

POSAR URL NOU GITHUB!!!

\newpage
# References 

(S'afegeixen al .bib que hi ha al Github pero ns si treure-ho pq nomes tenim el treball d'ell no?? o el posem?)









