---
# setspace: doublespacing
output: 
    pdf_document:
      includes:
        in_header: import.sty
        before_body: title.sty
      keep_tex: yes
      number_sections: yes
      # toc: yes
      toc_depth: 2

# linestretch: 2
bibliography: MasterOfCellTypes.bib
fontsize: 11
# csl: chicago-author-date.csl
csl: nature.csl
---

```{r include=FALSE, cache=FALSE}
library(knitr)
```

Resum 
====================================================

El Sorteig Extraordinari de Nadal, conegut popularment com la Loteria de Nadal, és un dels esdeveniments més populars  d'Espanya i se celebra cada desembre des de 1812. Aquest estudi analitza els resultats històrics del sorteig, incloent els números guanyadors, premis i categories, amb l'objectiu de trobar patrons i distribucions de manera estadística.

\newpage

Descripció del conjunt de dades
=======================================================================================================================

Introducció de les dades 
------------------------------------------------------------------------------------------------------------------------

En aquest repositori es recull el desenvolupament del Treball Final de Consultoria Estadística 2025, centrat en l'anàlisi exhaustiva de la Loteria de Nadal des de la seva vessant més tècnica. L'objectiu no és sols descriure el sorteig, sinó avaluar amb rigor estadístic si la variabilitat dels resultats històrics (des del 2000 fins a l'anys 2025) respon purament a l'atzar o si existeixen anomalies mesurables en l'homogeneïtat del sistes,

A través de metodologies de web scraping, tests d'independència .....

La Loteria de Nadal no és sols un sorteig de boles; és l'unic moment de l'any en què un país sencer es posa d'acord per ignorar les lleis de l'estadística. Des d'un punt de vista matemàtic, és un "impost a l'esperança", però des del punt de vista de lesa dades, és un ecosistema fascinant.

**L'arquitectura del "GORDO"**

El sistema de la Loteria Nacional no treballa amb números a l'atzar, sinó amb una jerarquia rígida que determina les probabilitats reals d'èxit. L'estructura per al sorteig actualment es basa en:

-   **Univers numèric:** 100.000 números únics (del 00000 al 99999). Això estableix una probabilitat base de guanyar el primer premi amb un sol dècim del 0.001%.

-   **Emissió:** La societat Estatal de Loteries i Apostes de l'Estat (SELAE) ha emès per l'any pasat 197 sèries per cada números. Atès que cada sèrie es divideix en 10 dècims, hi ha un total de 1970 dècims de cada número al mercat.

-   **Volum econòmic:** Amb un preu de 20€ per dècim, la recaptació potencial ascendeix a 3.940 milions d'euros. D'acord amb la normativa, el 70% d'aquest import es destina a premis.

**Física i Homogeneïtat del Sorteig**

Com assenyla el professor Llorenç Badiella, el que percebem com a folklore televisiu és, en realitat, un procés de física aplicada dissenyat per garantir l'equitat absoluta:

-   **Les boles:** Hi ha 100.000 boles al bombo gran, totes fabricades en fusta de boix, amb un diàmetre de 3 cm i un pes unificat.

-   **Impressió làser:** Per evitar que la pintura alteri el pes (eliminant la teoria que números amb molta tinta, com el 88888, pesen més que l'11111), els números estan gravats amb làser.

-   **Mecànica:** Es fan servir dos bombos simultanis, el gran per als números i el petit per a les 1805 boles de premis. Els sorteif només finalitza quan el bombo de premis queda totalment buit.

**El repartiment del "Pastís"**

Tot i que el focus està en el "Gordo", la realitat és que el sorteig és una "pluja fina" de premis petits, per augmentar l'esperança per l'any que ve.

| Premi                 | Import per dècim | Boles premiades     | Probabilitat |
|--------------------|-----------------|-------------------|-----------------|
| 1r premi ("el Gordo") | 400.000€         | 1                   | 0,001%       |
| 2n premi              | 125.000€         | 1                   | 0,001%       |
| 3r premi              | 50.000€          | 1                   | 0,001%       |
| 4rt premi             | 20.000€          | 2                   | 0,002%       |
| 5é premi              | 6.000€           | 8                   | 0,008%       |
| La Pedrea             | 100€             | 1.794               | 1,794%       |
| Reintegrament         | 20€              | 1 de cada 10 xifres | 10,00%       |

**Premi per proximitat i derivat**

Més enllà de les boles extretes, existeixen premis calculats per la relació numèrica amb els guanyadors:

-   **Aproximacions (a):** Premien els números immediatament anterior i posterior del "Gordo", 2n premi i del tercer, on s'obtén 200€, 125€ i 96€ respectivament.

-   **Centenes (c):** Es premien els 99 números que comparteixen les tres primeres xifres amb els quatre primers premis (tota la centena), on s'obtén 100€.

-   **Terminacions (t):** Es premien els números que coincideixen en les dues últimes xifres amb els tres primers premis, on s'obtén 100€.

-   **Reintegrament:** el retorn del valor del dècim (20€) si l'última xifra coincideix amb la del primer premi. Hi ha un 10% de probabilitat d'obtenir-lo.

**L'impacte Fiscal**

És important destacar que el premi "net" és inferior al nominal per a les quantitats grans. L'agència Tributària aplica un 20% d'impost a la quantitat que superi els 40.000€ (que estan exempts):

-   Gordo: Es tributa pel 20% de 360.00€. Premi net = 328.000€

-   2n Premi: Es tributa pel 20% de 85.000€. Premi net = 108.000€

-   3r Premi: Es tributa pel 20% de 10.000€ = 48.000€

Exploració de les dades
=======================================================================================================================

A continuació, presentarem diverses estadístiques descriptives i visualitzacions gràfiques que permetran observar el comportament de les dades.

Lectura de dades 
------------------------------------------------------------------------------------------------------------------------

En primer lloc, realitzarem una lectura inicial de tots els números premiats en els sortejos de la Loteria de Nadal corresponents al període 2011-2025. Les dades utilitzades provenen dels resultats oficials publicats després de cada sorteig per l'entitat corresponent.

L'endemà del sorteig, es publica l'arxiu corresponent per comprovar si un número ha estat premiat:

\begin{figure}[h]
  \centering
  \includegraphics[width=0.7\textwidth]{loteria.png}
  \caption{Resultats Sorteig loteria de nadal 2023}
\end{figure}

Realitzem una còpia de la informació d'aquest arxiu i la guardem en un fitxer .txt.

El codi encarregat de la lectura i del processament de les dades s'implementa en un script extern, que podeu trobar al directori del treball. També hem proporcionat el fitxer .xlsx corresponent, per tal que pugueu reproduir els resultats o utilitzar les dades directament.

Tot seguit, mostrarem alguns exemples dels premis per familiaritzar-nos amb el tipus de dades amb què treballarem en aquest estudi.

```{r}
library(readxl)
library(dplyr)
library(knitr)
library(kableExtra)
library(stringr)
library(dplyr)
library(tibble)
library(readxl)
library(readr)
datos <- read_excel("loteria_2015_2024.xlsx")
exemple <- head(datos[datos$any==2024,])
exemple %>%
  kable(caption = "Primers premis de la Loteria de Nadal 2024") %>% 
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover") )
```

La taula mostra un extracte dels números premiats corresponents al sorteig del 2024. Cada fila representa un número premiat, identificat per la seva xifra, i inclou informació addicional com la lletra associada. A més, cada registre té l'import del premi, la seva categoria, la moneda (en aquest cas, sempre seràn Euros) i l'any del sorteig.  

Anàlisi descriptiva
------------------------------------------------------------------------------------------------------------------------

```{r}
source("nateja_dades.R")
options(scipen = 999)
df <- nateja(datos)
df %>%
  summarise(
    `Años analizados` = n_distinct(any),
    `Total de números` = n(),
    `Premio mínimo (€)` = min(premio, na.rm = TRUE),
    `Premio máximo (€)` = max(premio, na.rm = TRUE),
    `Premio medio (€)` = round(mean(premio, na.rm = TRUE), 2)
  ) %>%
  kable(
    caption = "Resumen global de la Lotería de Navidad",
    align = "c"
  ) %>%
  kable_styling(full_width = FALSE)
```

Aquest conjunt de dades compta amb un dataset corresponent a cada any analitzat, amb una mida mitjana de 4000 números premiats per any.  Així que tindrem una mostra suficient per dur a terme el nostra anàlisis. 

```{r}
df %>%
  count(premio, name = "Frecuencia") %>%
  arrange(desc(Frecuencia)) %>%
  head(10) %>%
  kable(
    caption = "Premios más frecuentes en la Lotería de Navidad",
    col.names = c("Premio (€)", "Frecuencia"),
    align = "c"
  ) %>%
  kable_styling(full_width = FALSE)
```

```{r}
df %>%
  group_by(categoria) %>%
  summarise(
    `Nº observaciones` = n(),
    `Premio mínimo (€)` = min(premio, na.rm = TRUE),
    `Premio máximo (€)` = max(premio, na.rm = TRUE),
    `Premio medio (€)` = round(mean(premio, na.rm = TRUE), 2)
  ) %>%
  arrange(desc(`Nº observaciones`)) %>%
  kable(
    caption = "Análisis de premios por categoría",
    align = "c"
  ) %>%
  kable_styling(full_width = FALSE)
```

```{r}
df %>%
  count(letra)
```
```{r}
df %>%
  count(numero, name = "Veces premiado") %>%
  arrange(desc(`Veces premiado`)) %>%
  head(10) %>%
  kable(
    caption = "Números más premiados históricamente",
    align = "c"
  ) %>%
  kable_styling(full_width = FALSE)
```

Identificar números que no han sortit mai
```{r}
n <- tibble(numero = 00000:99999)
freq <- df %>%
  count(numero, name = "vegades_premiat") %>%
  arrange(desc(vegades_premiat))
freq <- freq %>%  mutate(numero = as.integer(numero))

mai <- n %>%
  anti_join(freq, by = "numero");
nrow(mai)
```

Visualització Gràfica
------------------------------------------------------------------------------------------------------------------------

A continuació visualitzarem diverses representacions gràfiques.

```{r}
library(dplyr)
library(ggplot2)
top_categorias <- df %>%
  count(categoria, sort = TRUE) %>%
  slice_head(n = 25) %>%
  pull(categoria)

df %>%
  filter(!is.na(premio), categoria %in% top_categorias) %>%
  ggplot(aes(x = categoria, y = premio)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(
    title = "Distribución del premio por categoría (Top 100 más usadas)",
    x = "Categoría",
    y = "Premio (€)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
df %>%
  count(categoria) %>%
  slice_head(n=10) %>%
  ggplot(aes(x = reorder(categoria, n), y = n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Número de premios por categoría (més alt)",
    x = "Categoría",
    y = "Número de premios"
  ) +
  theme_minimal() 
df %>%
  count(categoria) %>%
  slice_tail(n=10) %>%
  ggplot(aes(x = reorder(categoria, n), y = n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Número de premios por categoría(més baix)",
    x = "Categoría",
    y = "Número de premios"
  ) +
  theme_minimal() 

```

```{r}
library(dplyr)
library(tidyr)

# Convertir a character para separar dígitos
df_digitos <- df %>%
  filter(!is.na(numero)) %>%
  mutate(numero = as.character(numero)) %>%
  # Separar cada dígito en columnas
  mutate(
    d1 = substr(numero, 1, 1),
    d2 = substr(numero, 2, 2),
    d3 = substr(numero, 3, 3),
    d4 = substr(numero, 4, 4),
    d5 = substr(numero, 5, 5)
  ) %>%
  # Unir todos los dígitos en una sola columna
  pivot_longer(cols = d1:d5, names_to = "posicion", values_to = "digito")
library(dplyr)
library(tidyr)

# Convertir a character para separar dígitos
df_digitos <- df %>%
  filter(!is.na(numero)) %>%
  mutate(numero = as.character(numero)) %>%
  # Separar cada dígito en columnas
  mutate(
    d1 = substr(numero, 1, 1),
    d2 = substr(numero, 2, 2),
    d3 = substr(numero, 3, 3),
    d4 = substr(numero, 4, 4),
    d5 = substr(numero, 5, 5)
  ) %>%
  # Unir todos los dígitos en una sola columna
  pivot_longer(cols = d1:d5, names_to = "posicion", values_to = "digito")
library(ggplot2)

df_digitos %>%
  count(digito) %>%
  ggplot(aes(x = digito, y = n)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(
    title = "Frecuencia de los dígitos en los números de lotería",
    x = "Dígito",
    y = "Cantidad"
  ) +
  theme_minimal()

```


```{r}
a <- df %>%
  filter(!is.na(premio)) %>%
  filter(premio == max(premio)) %>%
  mutate(
    ultima_cifra = substr(numero, nchar(numero), nchar(numero))
  ) %>%
  count(ultima_cifra, sort=TRUE)

a %>%
  ggplot(aes(x = ultima_cifra, y = n)) +
  geom_col() +
  labs(
    title = "Freqüència de l’última xifra",
    x = "Última xifra del número",
    y = "Nombre de vegades"
  ) +
  theme_minimal()
```
```{r}
historial <- read_table2(
  "historial_gordo.txt",
  col_types = cols(
    Any = col_integer(),
    Numero = col_character(),
    Terminació = col_integer()))
df_plot <- historial %>%
  count(Terminació) %>%
  mutate(Terminació = factor(Terminació, levels = 0:9))

ggplot(df_plot, aes(x = Terminació, y = n, fill = n)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), vjust = -0.5, size = 4, fontface = "bold") + 
  scale_fill_gradient(low = "skyblue", high = "steelblue") +
  labs(title = "Distribució de la última xifra dels números premiats",
       subtitle = "Resultats Històrics de la Loteria de Nadal",
       x = "Última cifra",
       y = "Frecuencia") +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(face = "bold"),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold", size = 16),
        plot.subtitle = element_text(size = 12))
```
```{r}
library(dplyr)
library(ggplot2)
library(readr)
library(lubridate)
df <- df %>%
  mutate(ultima_cifra = as.integer(substr(numero, nchar(numero), nchar(numero))))

df_heat <- df %>%
  group_by(any, ultima_cifra) %>%
  summarise(frecuencia = n(), .groups = "drop")

# Heatmap solo colores
ggplot(df_heat, aes(x = factor(ultima_cifra), y = factor(any), fill = frecuencia)) +
  geom_tile(color = "white") +                   # cada celda
  scale_fill_gradient(low = "white", high = "steelblue") +  # degradado según frecuencia
  labs(
    title = "Mapa de calor de la última cifra de los números ganadores",
    subtitle = "Distribución por año",
    x = "Última cifra",
    y = "Año",
    fill = "Frecuencia"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12)
  )
```


Discussió possibles valors atípics
------------------------------------------------------------------------------------------------------------------------

Explicar com tractarem lo de que van cambiant el sorteig + PESETAS / EUROS

Que fem???

<!-- \newpage -->

Aplicació d'algorismes per la modelització
=======================================================================================================================

Metodologia
------------------------------------------------------------------------------------------------------------------------

Hi ha diversos algorismes que podem aplicar per desenvolupar un model predictiu, en aquest treball utilitzarem l'algorisme anomenat x. 

X és una tècnica on .... D'aquesta manera el model podrà...

x calcula .... i ....


Entranament del model amb el conjunt de dades 
------------------------------------------------------------------------------------------------------------------------
```{r}
library(dplyr)
library(ggplot2)
library(forecast)   # para ARIMA
library(tidyr)

# Suponemos que df ya tiene columnas: año, premio_num (premio numérico)
df <- df %>%
  mutate(premio_num = as.numeric(as.character(premio))) %>%
  filter(!is.na(premio_num))

# Extraer la grossa (premio más alto) por año
grossa_por_any <- df %>%
  group_by(any) %>%
  slice_max(premio_num, n = 1) %>%
  ungroup()
# Crear serie temporal
ts_grossa <- ts(grossa_por_any$premio_num, start = min(grossa_por_any$any), frequency = 1)

# Ajustar modelo ARIMA automáticamente
modelo_arima <- auto.arima(ts_grossa)

# Predicción a 5 años
prediccion <- forecast(modelo_arima, h = 5)

# Graficar la serie histórica + predicción
autoplot(prediccion) +
  labs(
    title = "Serie temporal de la Grossa de la Loteria de Nadal",
    x = "Año",
    y = "Premi més alt (€)"
  ) +
  theme_minimal()

```

Per entrenar el model amb ... hem ..... D'aquesta manera, podrem analitzar....

Hem dividir el dataset en conjunts d'entrenament i validació, amb les dades de l'any 2000 al 2024 dels resultats per entrenar el model i l'últim concurs realitzat al 2025 per a fer la validació. Així podrem observar el rendiment del model. 

Un cop preparada la mostra d'entrenament,.... Ja realitzat tot el prepossessing, ja podem definir i entrenar el model. 

L'estructura d'aquest es veu tal que:




Resultats
=======================================================================================================================



Presentació dels resultats 
------------------------------------------------------------------------------------------------------------------------

Mètriques d'avaluació
------------------------------------------------------------------------------------------------------------------------
\newpage
Conclusions 
=======================================================================================================================
\newpage
Annexos 
=======================================================================================================================

A continuació, introduirem el directori de Git-Hub on podràs trobar tot el codi d'R utilitzat:

https://github.com/MariaMM2204/Consultoria-2025

\newpage
# References 



